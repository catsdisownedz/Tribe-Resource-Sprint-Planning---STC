{% set is_login = (page == "login") %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Admin | Tribe Sprint Resource Planning</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{ --stc:#712C81; }
    body{
      font-family: system-ui,-apple-system, Segoe UI, Roboto, sans-serif;
      background:
        linear-gradient(180deg, rgba(113,44,129,0.04), rgba(113,44,129,0.02)),
        url("{{ url_for('static', filename='img/stc_bg.jpg') }}") center/cover fixed no-repeat;
      min-height:100vh;
    }
    .container-small{ max-width: 900px; }
    .navbar{ background: transparent; }
    .navbar a, .navbar-brand{ color:#fff; }
    .navbar-brand img{ height:32px; margin-right:.5rem; }
    .btn-primary{
      --bs-btn-bg:var(--stc);
      --bs-btn-border-color:var(--stc);
      --bs-btn-hover-bg:#5f246c;
      --bs-btn-hover-border-color:#5f246c;
    }
    .btn-outline-light:hover{ background:var(--stc); color:#fff; border-color:var(--stc); }
    .card{ border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.06); }
    .q-banner{ color:#000; }
    .q-banner1{ color:#fff; }
    .q-pill{ background:var(--stc); color:#fff; font-weight:700; padding:.25rem .6rem; border-radius:999px; }

    /* Progress */
    #upWrap{ display:none; }
    .progress{ height:10px; border-radius:999px; background:#f1e8f3; }
    .progress-bar{ background-color:var(--stc); transition:width .2s; }
    .indeterminate{ position:relative; overflow:hidden; }
    .indeterminate .progress-bar{ position:absolute; left:-40%; width:40%; animation:indet 1.2s infinite linear; }
    @keyframes indet{ 0%{left:-40%} 50%{left:60%} 100%{left:100%} }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand fw-semibold d-flex align-items-center" href="/">
        <img src="{{ url_for('static', filename='img/stc_logo.png') }}" alt="stc">
        Tribe Sprint Resource Planning — Admin
      </a>
      <div class="ms-auto d-flex gap-2">
        {% if is_login %}
          <a class="btn btn-outline-light btn-sm" href="/">Back</a>
        {% else %}
          <a class="btn btn-outline-light btn-sm" href="{{ url_for('admin.logout') }}">Logout</a>
        {% endif %}
      </div>
    </div>
  </nav>

  <main class="container container-small my-4">
    {% if is_login %}
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="card">
            <div class="card-body p-4">
              <h4 class="mb-3">Admin login</h4>
              <form method="post" action="{{ url_for('admin.do_login') }}" class="row g-2 align-items-center">
                <div class="col-sm-8">
                  <input class="form-control" type="password" name="password" placeholder="Password" required>
                </div>
                <div class="col-sm-4 d-grid">
                  <button class="btn btn-primary">Login</button>
                </div>
              </form>
              {% if error %}
                <div class="alert alert-danger my-3 py-2">{{ error }}</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% else %}
      <div class="row g-4">
        <!-- Current quarter banner -->
        <div class="col-12">
          <div class="q-banner1">
            <span>Current quarter:</span>
            <span class="q-pill">{{ current.name if current else '(not set)' }}</span>
          </div>
        </div>

        <div class="col-12">
          <div class="card">
            <div class="card-body p-4">
              <h4 class="mb-3">Upload resources Excel</h4>
              <p class="text-muted small mb-3">
                Expected columns (any order): <code>Tribe</code>, <code>App</code>, <code>Role</code>, <code>Resource</code>, <code>Reserved Sprints</code>.
              </p>

              <form id="uploadForm" class="row g-3">
                <div class="col-12">
                  <label class="form-label mb-1">Insert these resources into</label>
                  <div class="d-flex gap-3 align-items-center">
                    <div class="form-check text-dark">
                      <input class="form-check-input" type="radio" name="target" id="targetCurrent" value="current" checked>
                      <label class="form-check-label" for="targetCurrent">Current quarter</label>
                    </div>
                    <div class="form-check d-flex align-items-center gap-2 text-dark">
                      <input class="form-check-input" type="radio" name="target" id="targetNew" value="new">
                      <label class="form-check-label" for="targetNew">New quarter:</label>
                      <input type="text" id="newQuarterInput" name="new_quarter_name" class="form-control form-control-sm" placeholder="e.g., 2025Q4" style="max-width: 160px;" disabled>
                    </div>                    
                  </div>
                </div>

                <div class="col-sm-8">
                  <input type="file" name="file" id="fileInput" class="form-control" accept=".xlsx,.xls" required>
                </div>
                <div class="col-sm-4 d-grid">
                  <button id="uploadBtn" class="btn btn-primary">Upload</button>
                </div>
              </form>

              <!-- Progress UI -->
              <div id="upWrap" class="mt-3">
                <div class="small mb-1 text-white">Uploading data into database… <span id="upPct">0%</span></div>
                <div id="upBar" class="progress" aria-hidden="true">
                  <div class="progress-bar" role="progressbar" style="width:0%"></div>
                </div>
              </div>

              <div id="uploadResult" class="mt-3"></div>
            </div>
          </div>
        </div>
        <div id="uploadConflicts" class="mt-3"></div>
      </div>
    {% endif %}
  </main>

  <script>
    const uf = document.getElementById('uploadForm');
    const targetCurrent = document.getElementById('targetCurrent');
    const targetNew = document.getElementById('targetNew');
    const newQuarterInput = document.getElementById('newQuarterInput');
    const uploadBtn = document.getElementById('uploadBtn');

    function updateQuarterUI(){
      const isNew = targetNew && targetNew.checked;
      if (newQuarterInput){
        newQuarterInput.disabled = !isNew;
        if (!isNew){ newQuarterInput.value = ''; }
      }
      if (uploadBtn){
        uploadBtn.disabled = isNew && (!newQuarterInput || !newQuarterInput.value.trim());
      }
    }
    targetCurrent?.addEventListener('change', updateQuarterUI);
    targetNew?.addEventListener('change', updateQuarterUI);
    newQuarterInput?.addEventListener('input', updateQuarterUI);
    updateQuarterUI();

    // New: optional real-time progress (falls back gracefully)
    async function pollProgress(jobId, upPct, upBar, resBox){
      try{
        let done = false;
        while(!done){
          const r = await fetch(`/admin/upload_progress/${jobId}`);
          if(!r.ok) break;
          const j = await r.json();
          const pct = Math.max(1, Math.min(100, Math.round(j.percent || 0)));
          upPct.textContent = pct + '%';
          upBar.querySelector('.progress-bar').style.width = pct + '%';
          if (j.status === 'done'){
            resBox.innerHTML = `<div class="alert alert-success py-2">Uploaded ${j.rows || 0} rows into quarter (id: ${j.target_quarter_id ?? '-'}).</div>`;
            done = true;
            break;
          }
          if (j.status === 'error'){
            resBox.innerHTML = `<div class="alert alert-danger py-2">${j.error || 'Upload failed'}</div>`;
            done = true;
            break;
          }
          await new Promise(r => setTimeout(r, 500));
        }
      }catch(e){ console.error(e); }
    }

    if (uf) {
      uf.addEventListener('submit', async (e) => {
        e.preventDefault();
        const res = document.getElementById('uploadResult');
        const conflictsEl = document.getElementById('uploadConflicts');
        const upWrap = document.getElementById('upWrap');
        const upBar = document.getElementById('upBar');
        const upPct = document.getElementById('upPct');

        res.textContent = '';
        conflictsEl.textContent = '';
        upPct.textContent = '0%';
        upWrap.style.display = 'block';
        upBar.classList.remove('indeterminate');
        upBar.querySelector('.progress-bar').style.width = '0%';

        const fd = new FormData(uf);

        // 1) pre-validate (same as before)
        let vr = await fetch('{{ url_for("admin.upload_validate") }}', { method: 'POST', body: fd });
        let vj = await vr.json();
        if (!vj.ok) {
          upWrap.style.display = 'none';
          if (vj.error){
            conflictsEl.innerHTML = '<div class="alert alert-danger py-2">'+vj.error+'</div>';
            return;
          }
          if (Array.isArray(vj.conflicts) && vj.conflicts.length){
            let html = '<div class="alert alert-danger"><div class="fw-semibold mb-2">Couldn’t upload because of the following conflicts:</div>';
            for (const c of vj.conflicts){
              html += `<div class="mb-3">
                <div class="fw-semibold">${c.resource} was reserved for more than 6 sprints (total: ${c.total_reserved}).</div>
                <div class="small text-muted mb-1">Rows: ${c.rows.join(', ')}</div>
                <div class="table-responsive">
                  <table class="table table-sm table-bordered align-middle">
                    <thead><tr><th>Tribe</th><th>App</th><th>Role</th><th>Reserved Sprints</th><th>Resource</th></tr></thead><tbody>`;
              for (const r of c.rows_preview){
                html += `<tr><td>${r.tribe}</td><td>${r.app}</td><td>${r.role}</td><td>${r.reserved_sprints}</td><td>${r.resource}</td></tr>`;
              }
              html += `</tbody></table></div></div>`;
            }
            html += '</div>';
            conflictsEl.innerHTML = html;
            return;
          }
        }

        // 2) try progressive endpoint first
        try{
          const tryProg = await fetch('{{ url_for("admin.upload_excel_progress", _external=False) if url_for else "/admin/upload_excel_progress" }}', { method:'POST', body: fd });
          if (tryProg.ok){
            const pj = await tryProg.json();
            if (pj && pj.job_id){
              pollProgress(pj.job_id, upPct, upBar, res);
              return;
            }
          }
        }catch(_) {}

        // 3) fallback to original endpoint
        upBar.classList.add('indeterminate');
        upPct.textContent = 'processing…';

        const ur = await fetch('{{ url_for("admin.upload_excel") }}', { method: 'POST', body: fd });
        upBar.classList.remove('indeterminate');

        if (!ur.ok){
          res.innerHTML = '<div class="alert alert-danger py-2">' + await ur.text() + '</div>';
          return;
        }
        const j = await ur.json();
        upBar.querySelector('.progress-bar').style.width = '100%';
        upPct.textContent = '100%';
        res.innerHTML = '<div class="alert alert-success py-2">Uploaded '+j.rows+' rows into quarter (id: '+j.target_quarter_id+').</div>';
      });
    }
  </script>
</body>
</html>
